name: MLflow CI

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  mlflow_train:
    runs-on: ubuntu-latest

    env:
      MLFLOW_TRACKING_URI: sqlite:///mlflow.db
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      IMAGE_NAME: yourdockerhubusername/sales-linear-regression

    steps:
      # 1. Set up job
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Set up Python 3.10
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.10

      # 3. Check environment
      - name: Check Python version
        run: python --version

      # 4. Install dependencies via conda
      - name: Install Conda and environment
        uses: conda-incubator/setup-miniconda@v2
        with:
          auto-update-conda: true
          environment-file: MLProject/conda.yaml
          activate-environment: mlflow-env
          python-version: 3.10

      # 5. Run MLflow Project
      - name: Run MLflow Project
        run: |
          mlflow run MLProject -P input_path=MLProject/Sales-Transaction-v.4a_preprocessing.csv

      # 6. Get latest MLflow run_id
      - name: Get latest MLflow run
        run: |
          mlflow runs list --experiment-name "Sales Transaction - Linear Regression" | head -n 5

      # 7. Build Docker Image (optional)
      - name: Login to Docker Hub
        if: github.event_name == 'push'
        run: |
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin

      - name: Build Docker Image
        if: github.event_name == 'push'
        run: |
          mlflow build-docker MLProject -t $IMAGE_NAME

      - name: Push Docker Image
        if: github.event_name == 'push'
        run: |
          docker push $IMAGE_NAME
